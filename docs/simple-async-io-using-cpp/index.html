
    <head>
        <link rel="stylesheet" href="/styles.css">
        <link rel="stylesheet" href="/monokai.css">
    </head>
    <h1>Simple Async IO Using C++17</h1>

<p><em>2022-11-19</em></p>

<h2>An Example of What We'll Be Building</h2>

<div class="codehilite">
<pre><span></span><code><span class="c1">// example.cpp</span>

<span class="c1">// An echo server demonstrating the API we&#39;ll be building.</span>



<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;context.hpp&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;helpers.hpp&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;socket.hpp&quot;</span><span class="cp"></span>



<span class="k">struct</span><span class="w"> </span><span class="nc">Server</span><span class="p">;</span><span class="w"></span>



<span class="k">struct</span><span class="w"> </span><span class="nc">Client</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">Server</span><span class="o">*</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span><span class="w"></span>



<span class="w">    </span><span class="n">Socket</span><span class="w"> </span><span class="n">socket</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">closed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>



<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span><span class="w"></span>



<span class="w">    </span><span class="n">Client</span><span class="p">(</span><span class="n">Server</span><span class="o">&amp;</span><span class="w"> </span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="n">Socket</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">server</span><span class="p">{</span><span class="o">&amp;</span><span class="n">server</span><span class="p">},</span><span class="w"> </span><span class="n">socket</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">socket</span><span class="p">)}</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Start the receive loop</span>

<span class="w">        </span><span class="n">server</span><span class="o">-&gt;</span><span class="n">io_context</span><span class="p">.</span><span class="n">async_recv</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span><span class="w"></span>

<span class="w">                                      </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">recv_handler</span><span class="p">(</span><span class="n">len</span><span class="p">);</span><span class="w"> </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>



<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">recv_handler</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">            </span><span class="n">closed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="p">}</span><span class="w"></span>



<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received: %.*s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Copy the buffer onto the heap and tie its lifetime to</span>

<span class="w">        </span><span class="c1">// that of the lambda</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">shared_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">();</span><span class="w"></span>



<span class="w">        </span><span class="n">shared_buf</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">len</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="n">shared_buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span>



<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">buf_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shared_buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">();</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Write everything we received back</span>

<span class="w">        </span><span class="n">async_send_all</span><span class="p">(</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">io_context</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">buf_data</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"></span>

<span class="w">                       </span><span class="p">[</span><span class="n">shared_buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">shared_buf</span><span class="p">)](</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{});</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Queue this client to receive more</span>

<span class="w">        </span><span class="n">server</span><span class="o">-&gt;</span><span class="n">io_context</span><span class="p">.</span><span class="n">async_recv</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span><span class="w"></span>

<span class="w">                                      </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">recv_handler</span><span class="p">(</span><span class="n">len</span><span class="p">);</span><span class="w"> </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">};</span><span class="w"></span>



<span class="k">struct</span><span class="w"> </span><span class="nc">Server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="n">IOContext</span><span class="w"> </span><span class="n">io_context</span><span class="p">;</span><span class="w"></span>



<span class="w">    </span><span class="n">Socket</span><span class="w"> </span><span class="n">socket</span><span class="p">;</span><span class="w"></span>



<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">Client</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clients</span><span class="p">;</span><span class="w"></span>



<span class="w">    </span><span class="n">Server</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">socket</span><span class="p">{</span><span class="n">Socket</span><span class="o">::</span><span class="n">ListenParams</span><span class="p">{</span><span class="n">port</span><span class="p">}}</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>



<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">io_context</span><span class="p">.</span><span class="n">async_accept</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"></span>

<span class="w">                                </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="n">Socket</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">accept_handler</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span><span class="w"> </span><span class="p">});</span><span class="w"></span>

<span class="w">        </span><span class="n">io_context</span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>



<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">accept_handler</span><span class="p">(</span><span class="n">Socket</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Remove disconnected clients</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">clients_end</span><span class="w"> </span><span class="o">=</span><span class="w"></span>

<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">remove_if</span><span class="p">(</span><span class="n">clients</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">clients</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="p">[](</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">closed</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>



<span class="w">        </span><span class="n">clients</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">clients_end</span><span class="p">,</span><span class="w"> </span><span class="n">clients</span><span class="p">.</span><span class="n">end</span><span class="p">());</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Add the new socket</span>

<span class="w">        </span><span class="n">clients</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span><span class="w"></span>



<span class="w">        </span><span class="c1">// Continue accepting more clients</span>

<span class="w">        </span><span class="n">io_context</span><span class="p">.</span><span class="n">async_accept</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"></span>

<span class="w">                                </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="n">Socket</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">accept_handler</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span><span class="w"> </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">};</span><span class="w"></span>



<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="cp">#ifdef SERVER</span>

<span class="w">    </span><span class="c1">// Async IO server</span>

<span class="w">    </span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="p">{</span><span class="mi">42690</span><span class="p">};</span><span class="w"></span>



<span class="w">    </span><span class="n">server</span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w"></span>

<span class="cp">#else</span>

<span class="w">    </span><span class="c1">// Simple synchronous client</span>

<span class="w">    </span><span class="n">Socket</span><span class="w"> </span><span class="n">socket</span><span class="p">{</span><span class="n">Socket</span><span class="o">::</span><span class="n">ConnectParams</span><span class="p">{</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])}};</span><span class="w"></span>



<span class="w">    </span><span class="n">socket</span><span class="p">.</span><span class="n">set_non_blocking</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>



<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>



<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cin</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">send_all</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="n">recv_all</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">());</span><span class="w"></span>



<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="cp">#endif</span>



<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</code></pre>
</div>
